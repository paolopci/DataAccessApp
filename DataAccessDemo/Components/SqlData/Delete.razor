@rendermode InteractiveServer
@inject IPeopleData sql
@inject SelectedPersonState selectedPersonState
@inject NavigationManager navigationManager

<h3>Delete Person</h3>

<EditForm Model="person" OnValidSubmit="DeletePerson" FormName="deletePersonForm" class="p-3">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="mb-3">
        <label class="form-label" for="FirstName">First Name</label>
        <InputText id="FirstName" class="form-control" @bind-Value="person.FirstName" />
        <ValidationMessage For="() => person.FirstName" />
    </div>
    <div class="mb-3">
        <label class="form-label" for="LastName">Last Name</label>
        <InputText id="LastName" class="form-control" @bind-Value="person.LastName" />
        <ValidationMessage For="() => person.LastName" />
    </div>
    <button type="submit" class="btn btn-primary mt-2">Delete Person</button>
</EditForm>

@code {
    private PersonModel person = new();

    protected override void OnInitialized()
    {
        selectedPersonState.PersonChanged += LoadSelectedPerson;
        LoadSelectedPerson();
    }

    private async Task DeletePerson()
    {
        if (person.Id == 0)
        {
            return;
        }

        await sql.DeletePerson(person.Id);
        selectedPersonState.Clear();
        navigationManager.NavigateTo("/", forceLoad: true);
    }

    private void LoadSelectedPerson()
    {
        if (selectedPersonState.Person is not null)
        {
            var selected = selectedPersonState.Person;
            person = new PersonModel
                {
                    Id = selected.Id,
                    FirstName = selected.FirstName,
                    LastName = selected.LastName
                };
            StateHasChanged();
        }
        else
        {
            person = new PersonModel();
            StateHasChanged();
        }
    }
}
